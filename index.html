<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üé§ AI English Speaking Partner</title>
    <style>
      :root {
        --color-background: rgba(252, 252, 249, 1);
        --color-surface: rgba(255, 255, 253, 1);
        --color-text: rgba(19, 52, 59, 1);
        --color-text-secondary: rgba(98, 108, 113, 1);
        --color-primary: rgba(33, 128, 141, 1);
        --color-primary-hover: rgba(29, 116, 128, 1);
        --color-border: rgba(94, 82, 64, 0.2);
        --color-success: rgba(33, 128, 141, 1);
        --color-error: rgba(192, 21, 47, 1);
        --radius-lg: 12px;
        --space-16: 16px;
        --space-24: 24px;
        --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --color-background: rgba(31, 33, 33, 1);
          --color-surface: rgba(38, 40, 40, 1);
          --color-text: rgba(245, 245, 245, 1);
          --color-text-secondary: rgba(167, 169, 169, 0.7);
          --color-primary: rgba(50, 184, 198, 1);
          --color-primary-hover: rgba(45, 166, 178, 1);
          --color-border: rgba(119, 124, 124, 0.3);
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family-base);
        background-color: var(--color-background);
        color: var(--color-text);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: var(--space-16);
      }

      .container {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        padding: 32px;
        max-width: 600px;
        width: 100%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04);
      }

      h1 {
        text-align: center;
        margin-bottom: 24px;
        font-size: 24px;
        font-weight: 600;
      }

      .chat-box {
        background: var(--color-background);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 16px;
        min-height: 300px;
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
      }

      .message {
        margin-bottom: 12px;
        padding: 10px 14px;
        border-radius: 8px;
        line-height: 1.5;
      }

      .user-message {
        background: var(--color-primary);
        color: white;
        margin-left: 20%;
        text-align: right;
      }

      .ai-message {
        background: var(--color-border);
        color: var(--color-text);
        margin-right: 20%;
      }

      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      button {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      #startBtn {
        background: var(--color-primary);
        color: white;
      }

      #startBtn:hover:not(:disabled) {
        background: var(--color-primary-hover);
      }

      #startBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #stopBtn {
        background: var(--color-error);
        color: white;
      }

      #stopBtn:hover:not(:disabled) {
        opacity: 0.9;
      }

      #stopBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .status {
        text-align: center;
        margin-top: 16px;
        font-size: 14px;
        color: var(--color-text-secondary);
        min-height: 20px;
      }

      .listening {
        color: var(--color-error);
        font-weight: 600;
      }

      .footer {
        text-align: center;
        margin-top: 20px;
        font-size: 12px;
        color: var(--color-text-secondary);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé§ AI English Speaking Partner</h1>

      <div class="chat-box" id="chatBox">
        <div class="ai-message message">
          Hello! Let's start speaking in English. Click "Start" and speak when
          you see the microphone icon.
        </div>
      </div>

      <div class="controls">
        <button id="startBtn">üé§ Start Speaking</button>
        <button id="stopBtn" disabled>‚èπ Stop</button>
      </div>

      <div class="status" id="status"></div>

      <div class="footer">üí¨ Developed by Pallavi</div>
    </div>

    <script>
      const API_KEY = "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";
      const chatBox = document.getElementById("chatBox");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const status = document.getElementById("status");

      let recognition;
      let isListening = false;

      // Check browser support
      if (
        "webkitSpeechRecognition" in window ||
        "SpeechRecognition" in window
      ) {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = "en-US";

        recognition.onstart = () => {
          status.innerHTML = '<span class="listening">üé§ Listening...</span>';
        };

        recognition.onresult = async (event) => {
          const userText = event.results[0][0].transcript;
          addMessage(userText, "user");

          if (userText.toLowerCase().includes("stop")) {
            speakText("Okay! Goodbye and keep practicing English.");
            addMessage("Goodbye! Keep practicing.", "ai");
            setTimeout(() => stopListening(), 2000);
            return;
          }

          status.textContent = "ü§ñ AI is thinking...";
          const aiReply = await getAIReply(userText);

          // Check if still listening before continuing
          if (!isListening) return;

          addMessage(aiReply, "ai");
          await speakTextAsync(aiReply);

          // Auto restart listening after AI speaks (with longer delay)
          setTimeout(() => {
            if (isListening) {
              recognition.start();
            }
          }, 2000);
        };

        recognition.onerror = (event) => {
          console.error("Speech recognition error:", event.error);
          status.textContent = "‚ö†Ô∏è Error: " + event.error;
          if (event.error === "no-speech") {
            status.textContent = "‚ö†Ô∏è No speech detected. Click Start again.";
            if (isListening) {
              setTimeout(() => recognition.start(), 1000);
            }
          }
        };

        recognition.onend = () => {
          if (isListening) {
            status.textContent = "Ready to listen...";
          } else {
            status.textContent = "";
          }
        };
      } else {
        alert(
          "‚ö†Ô∏è Your browser does not support speech recognition. Please use Chrome or Edge."
        );
        startBtn.disabled = true;
      }

      startBtn.addEventListener("click", () => {
        isListening = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;

        // Stop any ongoing speech first
        if ("speechSynthesis" in window) {
          speechSynthesis.cancel();
        }

        speakText(
          "Hello! Let's start speaking in English. You can say stop to exit."
        );
        setTimeout(() => {
          if (isListening) {
            recognition.start();
          }
        }, 2500);
      });

      stopBtn.addEventListener("click", stopListening);

      function stopListening() {
        isListening = false;

        // Stop speech recognition
        if (recognition) {
          recognition.stop();
        }

        // Stop any ongoing speech synthesis
        if ("speechSynthesis" in window) {
          speechSynthesis.cancel();
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;
        status.textContent = "Stopped. Click Start to begin again.";
      }

      function addMessage(text, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}-message`;
        messageDiv.textContent =
          sender === "user" ? `You: ${text}` : `AI: ${text}`;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function getAIReply(userText) {
        try {
          const response = await fetch(
            "https://api.perplexity.ai/chat/completions",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${API_KEY}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model: "sonar",
                messages: [
                  {
                    role: "system",
                    content:
                      "You are a friendly English-speaking partner. Respond casually and naturally. Keep your answers short (1‚Äì2 sentences). Do not explain or define anything ‚Äî just chat like a friend.",
                  },
                  {
                    role: "user",
                    content: userText,
                  },
                ],
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
          }

          const data = await response.json();
          return data.choices[0].message.content.trim();
        } catch (error) {
          console.error("API Error:", error);
          return "Sorry, I couldn't connect to the AI.";
        }
      }

      function speakText(text) {
        if ("speechSynthesis" in window) {
          speechSynthesis.cancel(); // Cancel any ongoing speech
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.rate = 0.95;
          utterance.pitch = 1;
          utterance.volume = 1;

          // Try to get female voice
          const voices = speechSynthesis.getVoices();
          const femaleVoice = voices.find(
            (voice) =>
              voice.name.includes("Female") ||
              voice.name.includes("Samantha") ||
              voice.name.includes("Google UK English Female")
          );
          if (femaleVoice) {
            utterance.voice = femaleVoice;
          }

          speechSynthesis.speak(utterance);
        }
      }

      // Async version for better control
      function speakTextAsync(text) {
        return new Promise((resolve) => {
          if ("speechSynthesis" in window) {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.95;
            utterance.pitch = 1;
            utterance.volume = 1;

            const voices = speechSynthesis.getVoices();
            const femaleVoice = voices.find(
              (voice) =>
                voice.name.includes("Female") ||
                voice.name.includes("Samantha") ||
                voice.name.includes("Google UK English Female")
            );
            if (femaleVoice) {
              utterance.voice = femaleVoice;
            }

            utterance.onend = () => resolve();
            utterance.onerror = () => resolve();

            speechSynthesis.speak(utterance);
          } else {
            resolve();
          }
        });
      }

      // Load voices
      if ("speechSynthesis" in window) {
        speechSynthesis.getVoices();
        window.speechSynthesis.onvoiceschanged = () => {
          speechSynthesis.getVoices();
        };
      }
    </script>
  </body>
</html>
